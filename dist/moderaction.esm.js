class t{async get(t){throw new Error("Adapter.get not implemented")}async post(t,e){throw new Error("Adapter.post not implemented")}async getForm(t,e){throw new Error("Adapter.getForm not implemented")}bridge(t){throw new Error("Adapter.bridge not implemented")}get tid(){return null}get pagetype(){return""}}function e(t){return(new DOMParser).parseFromString(t,"text/html")}async function r(t,r){const o=function(t){var e=new FormData;for(var r in t)e.append(r,t[r]);return[...e.entries()].map(t=>`${encodeURIComponent(t[0])}=${encodeURIComponent(t[1])}`).join("&")}(r),n=await fetch(t,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:o}),s=await n.text();return{ok:n.ok,status:n.status,text:s,doc:e(s)}}const o={get tid(){return function(){const t=document.querySelector("input[name=tid]");if(t?.value)return t.value;const e=document.querySelector("a[href*='&tid=']"),r=(e?.getAttribute("href")||"").match(/[?&]tid=([a-z0-9]+)/i);if(r)return r[1];const o=location.pathname,n=o.match(/\/t(\d+)(?:p\d+)?-/);if(n)return n[1];const s=o.match(/\/f(\d+)(?:p\d+)?-/);return s?s[1]:null}()},get pagetype(){return function(){const t=location.pathname;if(/^\/t\d+(p\d+)?-/.test(t))return"topic";if(/^\/f\d+(p\d+)?-/.test(t))return"forum";if(/^\/c\d+-/.test(t))return"category";const e=(t+location.search).match(/\/modcp\?mode=([^&]+)/);return e?e[1]:""}()}};function n(t,e){return Array.from(t.querySelectorAll(e))}function s(t){return(t||"").replace(/\s+/g," ").trim()}function i(t){return s(t).toLowerCase()}const a={"topic.move":["déplac","moved"],"topic.lock":["verrouill","locked"],"topic.unlock":["déverrouill","unlocked"],"topic.delete":["supprim","deleted","removed"],"topic.trash":["corbeille","poubelle","trash"],"topic.post":["répon","posted","reply"],"forum.post":["nouveau sujet","sujet a été créé","topic has been created","new topic"],"user.pm":["message priv","private message"],"user.ban":["banni","banned"],"user.unban":["débanni","unbann"]},d=["aucun","erreur","error","forbidden","not allowed","non autorisé","permission"];function c(t){const e={};if(!t)return e;const r=t.match(/\/(?:t|viewtopic\?.*?t=)(\d+)/);r&&(e.topic_id=Number(r[1]));const o=t.match(/\/f(\d+)-/);o&&(e.forum_id=Number(o[1]));const n=t.match(/#(\d+)$/);return n&&(e.post_id=Number(n[1])),e}function u(t){const e=s(function(t){const e=[],r=new Set(["SCRIPT","STYLE","NOSCRIPT","IFRAME"]),o=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode(t){const e=t.parentElement;return!e||r.has(e.tagName)?NodeFilter.FILTER_REJECT:(t.nodeValue||"").trim()?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let n;for(;n=o.nextNode();)e.push(n.nodeValue);return e}(t.body||t).join(" ")),r=function(t,e){const r=" "+s(t)+" ",o=e.map(t=>r.indexOf(t)).filter(t=>t>=0).sort((t,e)=>t-e)[0];if(void 0===o)return"";const n=Math.max(0,r.lastIndexOf(".",o)+1,r.lastIndexOf("!",o)+1,r.lastIndexOf("?",o)+1,r.lastIndexOf("\n",o)+1);let i=r.indexOf(".",o);return-1===i&&(i=r.length),r.slice(n,i).trim()||r.trim()}(e,Array.from(new Set(Object.values(a).flat())).map(i));if(r)return r;const o=(t.querySelector("p")||{}).textContent||"";return o.trim()?s(o):e}function p(t){const{doc:e,text:r}=t,o=u(e),s=function(t){const e={topic_id:void 0,forum_id:void 0,post_id:void 0};for(const r of n(t,"a[href]")){const t=c(r.getAttribute("href")||"");void 0===e.topic_id&&void 0!==t.topic_id&&(e.topic_id=t.topic_id),void 0===e.forum_id&&void 0!==t.forum_id&&(e.forum_id=t.forum_id),void 0===e.post_id&&void 0!==t.post_id&&(e.post_id=t.post_id)}return e}(e),p=e.querySelector("a[href]"),m=p?p.getAttribute("href"):"",h={...s,...c(m)},l=function(t){const e=i(t);for(const[t,r]of Object.entries(a))if(r.some(t=>e.includes(t)))return t;return"unknown"}(o);let f=function(t,e){const r=a[t]||[],o=i(e),n=r.some(t=>o.includes(t)),s=d.some(t=>o.includes(t));return n&&!s}(l,o);e.querySelector(".box-content.error, .error, .panel .error, .errorbox")&&(f=!1);const g={first:m||void 0,topic:n(e,'a[href^="/t"], a[href*="viewtopic"]').map(t=>t.getAttribute("href"))[0]||void 0,forum:n(e,'a[href^="/f"]').map(t=>t.getAttribute("href"))[0]||void 0};return{ok:f,status:t.status,action:l,message:o,ids:h,links:g,href:m,raw:r}}const m=new class extends t{async get(t){return async function(t){const r=await fetch(t,{credentials:"same-origin"}),o=await r.text();return{ok:r.ok,status:r.status,text:o,doc:e(o)}}(t)}async post(t,e){return r(t,e)}async getForm(t,e){const r=await this.get(t);if(!r.ok)return{ok:!1,status:r.status,text:r.text};const o=r.doc.querySelector(e);if(!o)return{ok:!1,status:404,text:"Form not found"};const n=new FormData(o);return{ok:!0,data:Object.fromEntries(n.entries()),doc:r.doc}}bridge(t){return p(t)}get tid(){return o.tid}get pagetype(){return o.pagetype}},h=Array.isArray;function l(t){return(e=t,null==e?[]:h(e)?e:[e]).filter(t=>null!=t).map(t=>"number"==typeof t?t:parseInt(String(t),10)).filter(t=>Number.isFinite(t)&&t>0);var e}class f{constructor(t,e){this.ids=l(t),this.adapter=e}_all(t){return Promise.all(t)}}class g extends f{async post(t){const{subject:e,message:r,notify:o=0}=t||{};if(!e||!r)throw new Error("Forum.post: subject et message sont requis");const n=this.ids.map(t=>this.adapter.post("/post",{post:1,mode:"newtopic",f:t,subject:e,message:r,notify:o}).then(t=>this.adapter.bridge(t)));return this._all(n)}}class w extends f{async post(t){const{message:e,notify:r=0}=t||{};if(!e)throw new Error("Topic.post: message est requis");const o=this.ids.map(t=>this.adapter.post("/post",{post:1,mode:"reply",t:t,message:e,notify:r}).then(t=>this.adapter.bridge(t)));return this._all(o)}async lock(){const t=this.adapter.tid;if(!t)throw new Error("Topic.lock: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=lock&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async unlock(){const t=this.adapter.tid;if(!t)throw new Error("Topic.unlock: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=unlock&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async move(t){if(!t)throw new Error("Topic.move: forum id manquant");const e=this.adapter.tid;if(!e)throw new Error("Topic.move: tid introuvable");const r=this.ids.map(r=>this.adapter.post(`/modcp?tid=${e}`,{tid:e,new_forum:"f"+t,mode:"move",t:r,confirm:1}).then(t=>this.adapter.bridge(t)));return this._all(r)}async trash(){const t=this.adapter.tid;if(!t)throw new Error("Topic.trash: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=trash&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async remove(){const t=this.adapter.tid;if(!t)throw new Error("Topic.remove: tid introuvable");const e=this.ids.map(e=>this.adapter.post(`/modcp?tid=${t}`,{t:e,mode:"delete",confirm:1}).then(t=>this.adapter.bridge(t)));return this._all(e)}}class b extends f{async remove(){const t=this.ids.map(t=>this.adapter.post("/post",{p:t,mode:"delete",confirm:""}).then(t=>this.adapter.bridge(t)));return this._all(t)}async change({message:t}){if(!t)throw new Error("Post.change: message requis");const e=this.ids.map(async e=>{const r=await this.adapter.getForm(`/post?p=${e}&mode=editpost`,'form[name="post"]');if(!r.ok)return r;const o={...r.data,message:t};o.post=1;const n=await this.adapter.post("/post",o);return this.adapter.bridge(n)});return this._all(e)}}class y extends f{async pm({subject:t,message:e}){if(!t||!e)throw new Error("User.pm: subject et message requis");const r=this.ids.join(", "),o=await this.adapter.post("/privmsg",{username:r,mode:"post",post:1,subject:t,message:e});return this.adapter.bridge(o)}async ban({days:t=0,reason:e=""}={}){const r=this.adapter.tid;if(!r)throw new Error("User.ban: tid introuvable");const o=this.ids.map(o=>this.adapter.post(`/modcp?tid=${r}`,{tid:r,confirm:1,mode:"ban",user_id:o,ban_user_date:t,ban_user_reason:e}).then(t=>this.adapter.bridge(t)));return this._all(o)}async unban(){const t=this.adapter.tid;if(!t)throw new Error("User.unban: tid introuvable");const e=await this.adapter.post(`/admin/index.forum?part=users_groups&sub=users&mode=ban_control&extended_admin=1&tid=${t}`,{users_to_unban:this.ids,unban_users:1});return this.adapter.bridge(e)}}class v extends f{constructor(t){super([],t)}async post({message:t}){if(!t)throw new Error("Chat.post: message requis");return await this.adapter.post("/chatbox/actions.forum",{method:"send",archive:0,message:t}),{ok:!0}}}const _={forum:t=>new g(t,m),topic:t=>new w(t,m),post:t=>new b(t,m),user:t=>new y(t,m),chat:()=>new v(m),adapter:m};"undefined"!=typeof window&&(window.Moderactor=_);export{_ as default};
//# sourceMappingURL=moderaction.esm.js.map
