var Moderaction=function(){"use strict";class t{async get(t){throw new Error("Adapter.get not implemented")}async post(t,e){throw new Error("Adapter.post not implemented")}async getForm(t,e){throw new Error("Adapter.getForm not implemented")}bridge(t){throw new Error("Adapter.bridge not implemented")}get tid(){return null}get pagetype(){return""}}function e(t){return(new DOMParser).parseFromString(t,"text/html")}async function r(t,r){const s=function(t){var e=new FormData;for(var r in t)e.append(r,t[r]);return[...e.entries()].map(t=>`${encodeURIComponent(t[0])}=${encodeURIComponent(t[1])}`).join("&")}(r),n=await fetch(t,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},body:s}),o=await n.text();return{ok:n.ok,status:n.status,text:o,doc:e(o)}}const s={get tid(){return function(){const t=document.querySelector("input[name=tid]");if(t?.value)return t.value;const e=document.querySelector("a[href*='&tid=']"),r=(e?.getAttribute("href")||"").match(/[?&]tid=([a-z0-9]+)/i);if(r)return r[1];const s=location.pathname,n=s.match(/\/t(\d+)(?:p\d+)?-/);if(n)return n[1];const o=s.match(/\/f(\d+)(?:p\d+)?-/);return o?o[1]:null}()},get pagetype(){return function(){const t=location.pathname;if(/^\/t\d+(p\d+)?-/.test(t))return"topic";if(/^\/f\d+(p\d+)?-/.test(t))return"forum";if(/^\/c\d+-/.test(t))return"category";const e=(t+location.search).match(/\/modcp\?mode=([^&]+)/);return e?e[1]:""}()},get resid(){return function(){const t=location.pathname;let e=t.match(/^\/[tfc](\d+)(?:p\d+)?-/);return e||(e=t.match(/^\/u(\d+)/)),e?Number(e[1]):0}()},get pagenum(){return function(){const t=location.pathname.match(/^\/[tf]\d+(p\d+)-/);return t?Number(t[1].slice(1)):0}()},get charset(){return(document.charset||document.characterSet||"utf-8").toLowerCase()}};function n(t,e){return Array.from(t.querySelectorAll(e))}function o(t){const{doc:e,text:r}=t,s=function(t){return Array.from(t.querySelectorAll("p")).map(t=>t.textContent.trim()).join(" ").replace(/\s+/g," ").trim()}(e),o=(a="a[href]",e.querySelector(a)||void 0);var a;const i=o?o.getAttribute("href"):"",c=function(t){const e={};if(!t)return e;const r=t.match(/\/(?:t|viewtopic\?.*?t=)(\d+)/);r&&(e.topic_id=Number(r[1]));const s=t.match(/\/f(\d+)-/);s&&(e.forum_id=Number(s[1]));const n=t.match(/#(\d+)$/);return n&&(e.post_id=Number(n[1])),e}(i),d=function(t){const e=(t||"").toLowerCase();return/déplacé/.test(e)?"topic.move":/verrouill/.test(e)&&!/déverrouill/.test(e)?"topic.lock":/déverrouill/.test(e)?"topic.unlock":/supprim/.test(e)?"topic.delete":/corbeille|poubelle/.test(e)?"topic.trash":/répon|enregistré avec succès/.test(e)?"topic.post":/nouveau sujet/.test(e)?"forum.post":/message priv/.test(e)?"user.pm":/banni/.test(e)?"user.ban":/débanni|unban/.test(e)?"user.unban":"unknown"}(s),u=function(t,e){const r=(e||"").toLowerCase();switch(t){case"topic.move":return/déplacé/.test(r);case"topic.lock":return/verrouill/.test(r);case"topic.unlock":return/déverrouill/.test(r);case"topic.delete":return/supprim/.test(r);case"topic.trash":return/corbeille|poubelle/.test(r);case"topic.post":return/répon|enregistré avec succès/.test(r);case"forum.post":return/nouveau sujet/.test(r);case"user.pm":return/message priv/.test(r);case"user.ban":return/banni/.test(r);case"user.unban":return/débanni|unban/.test(r);default:return!1}}(d,s),p={first:i||void 0,topic:n(e,'a[href^="/t"], a[href*="viewtopic"]').map(t=>t.getAttribute("href"))[0]||void 0,forum:n(e,'a[href^="/f"]').map(t=>t.getAttribute("href"))[0]||void 0};return{ok:u,status:t.status,action:d,message:s,ids:c,links:p,href:i,raw:r}}const a=new class extends t{async get(t){return async function(t){const r=await fetch(t,{credentials:"same-origin"}),s=await r.text();return{ok:r.ok,status:r.status,text:s,doc:e(s)}}(t)}async post(t,e){return r(t,e)}async getForm(t,e){const r=await this.get(t);if(!r.ok)return{ok:!1,status:r.status,text:r.text};const s=r.doc.querySelector(e);if(!s)return{ok:!1,status:404,text:"Form not found"};const n=new FormData(s);return{ok:!0,data:Object.fromEntries(n.entries()),doc:r.doc}}bridge(t){return o(t)}get tid(){return s.tid}get pagetype(){return s.pagetype}},i=Array.isArray;function c(t){return(e=t,null==e?[]:i(e)?e:[e]).filter(t=>null!=t).map(t=>"number"==typeof t?t:parseInt(String(t),10)).filter(t=>Number.isFinite(t)&&t>0);var e}class d{constructor(t,e){this.ids=c(t),this.adapter=e}_all(t){return Promise.all(t)}}class u extends d{async post(t){const{subject:e,message:r,notify:s=0}=t||{};if(!e||!r)throw new Error("Forum.post: subject et message sont requis");const n=this.ids.map(t=>this.adapter.post("/post",{post:1,mode:"newtopic",f:t,subject:e,message:r,notify:s}).then(t=>this.adapter.bridge(t)));return this._all(n)}}class p extends d{async post(t){const{message:e,notify:r=0}=t||{};if(!e)throw new Error("Topic.post: message est requis");const s=this.ids.map(t=>this.adapter.post("/post",{post:1,mode:"reply",t:t,message:e,notify:r}).then(t=>this.adapter.bridge(t)));return this._all(s)}async lock(){const t=this.adapter.tid;if(!t)throw new Error("Topic.lock: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=lock&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async unlock(){const t=this.adapter.tid;if(!t)throw new Error("Topic.unlock: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=unlock&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async move(t){if(!t)throw new Error("Topic.move: forum id manquant");const e=this.adapter.tid;if(!e)throw new Error("Topic.move: tid introuvable");const r=this.ids.map(r=>this.adapter.post(`/modcp?tid=${e}`,{tid:e,new_forum:"f"+t,mode:"move",t:r,confirm:1}).then(t=>this.adapter.bridge(t)));return this._all(r)}async trash(){const t=this.adapter.tid;if(!t)throw new Error("Topic.trash: tid introuvable");const e=this.ids.map(e=>this.adapter.get(`/modcp?mode=trash&t=${e}&tid=${t}`).then(t=>this.adapter.bridge(t)));return this._all(e)}async remove(){const t=this.adapter.tid;if(!t)throw new Error("Topic.remove: tid introuvable");const e=this.ids.map(e=>this.adapter.post(`/modcp?tid=${t}`,{t:e,mode:"delete",confirm:1}).then(t=>this.adapter.bridge(t)));return this._all(e)}}class m extends d{async remove(){const t=this.ids.map(t=>this.adapter.post("/post",{p:t,mode:"delete",confirm:""}).then(t=>this.adapter.bridge(t)));return this._all(t)}async change({message:t}){if(!t)throw new Error("Post.change: message requis");const e=this.ids.map(async e=>{const r=await this.adapter.getForm(`/post?p=${e}&mode=editpost`,'form[name="post"]');if(!r.ok)return r;const s={...r.data,message:t};s.post=1;const n=await this.adapter.post("/post",s);return this.adapter.bridge(n)});return this._all(e)}}class h extends d{async pm({subject:t,message:e}){if(!t||!e)throw new Error("User.pm: subject et message requis");const r=this.ids.join(", "),s=await this.adapter.post("/privmsg",{username:r,mode:"post",post:1,subject:t,message:e});return this.adapter.bridge(s)}async ban({days:t=0,reason:e=""}={}){const r=this.adapter.tid;if(!r)throw new Error("User.ban: tid introuvable");const s=this.ids.map(s=>this.adapter.post(`/modcp?tid=${r}`,{tid:r,confirm:1,mode:"ban",user_id:s,ban_user_date:t,ban_user_reason:e}).then(t=>this.adapter.bridge(t)));return this._all(s)}async unban(){const t=this.adapter.tid;if(!t)throw new Error("User.unban: tid introuvable");const e=await this.adapter.post(`/admin/index.forum?part=users_groups&sub=users&mode=ban_control&extended_admin=1&tid=${t}`,{users_to_unban:this.ids,unban_users:1});return this.adapter.bridge(e)}}class l extends d{constructor(t){super([],t)}async post({message:t}){if(!t)throw new Error("Chat.post: message requis");return await this.adapter.post("/chatbox/actions.forum",{method:"send",archive:0,message:t}),{ok:!0}}}const f={forum:t=>new u(t,a),topic:t=>new p(t,a),post:t=>new m(t,a),user:t=>new h(t,a),chat:()=>new l(a),adapter:a,env:async function(t){if(!t)return{url:location.href,tid:s.tid,pagetype:s.pagetype,resid:s.resid,pagenum:s.pagenum,charset:s.charset,anchorId:location.hash?location.hash.substring(1):null};const e=await fetch(t,{credentials:"same-origin"}),r=await e.text(),n=(new DOMParser).parseFromString(r,"text/html"),o=new URL(t,location.href),a=o.pathname,i=o.hash?o.hash.substring(1):null,c=a.match(/\/t(\d+)(?:p\d+)?-/),d=a.match(/\/f(\d+)(?:p\d+)?-/);return{url:t,tid:n.querySelector("input[name=tid]")?.value||(c?c[1]:null)||(d?d[1]:null),pagetype:/^\/t\d+(p\d+)?-/.test(a)?"topic":/^\/f\d+(p\d+)?-/.test(a)?"forum":/^\/c\d+-/.test(a)?"category":"",resid:(()=>{let t=a.match(/^\/[tfc](\d+)(?:p\d+)?-/);return t||(t=a.match(/^\/u(\d+)/)),t?Number(t[1]):0})(),pagenum:(()=>{const t=a.match(/^\/[tf]\d+(p\d+)-/);return t?Number(t[1].slice(1)):0})(),charset:(n.characterSet||"utf-8").toLowerCase(),anchorId:i}}};return"undefined"!=typeof window&&(window.Moderactor=f),f}();
//# sourceMappingURL=moderactor.js.map
